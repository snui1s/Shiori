---
interface Props {
  // Select Mode Props
  name?: string;
  value?: string;
  options?: { value: string; label: string }[] | string[];
  placeholder?: string;
  submitOnChange?: boolean;

  // Generic Props
  class?: string;
  triggerClass?: string;
  menuClass?: string;

  // Behavior
  closeOnClickInside?: boolean;
}

const {
  name,
  value = "",
  options = [],
  placeholder = "Select...",
  submitOnChange = false,
  class: className = "",
  triggerClass = "",
  menuClass = "",
  closeOnClickInside = true,
} = Astro.props;

// Determine mode
const isSelect = options.length > 0;

// Normalize options to object format (only used in Select Mode)
const normalizedOptions = options.map((opt) =>
  typeof opt === "string" ? { value: opt, label: opt } : opt,
);

const currentLabel =
  normalizedOptions.find((opt) => opt.value === value)?.label || placeholder;

// Generate unique ID
const id = Math.random().toString(36).substr(2, 9);
---

<div class={`relative ${className}`} id={`dropdown-${id}`}>
  {
    isSelect && (
      <input type="hidden" name={name} id={`input-${id}`} value={value} />
    )
  }

  <button
    type="button"
    id={`toggle-${id}`}
    class={triggerClass ||
      "w-full h-full min-h-[56px] py-4 pl-6 pr-12 bg-black/20 rounded-[1.5rem] text-white text-left font-bold relative transition-all duration-300 hover:bg-black/30 cursor-pointer flex items-center justify-between md:min-w-[220px]"}
  >
    {
      isSelect ? (
        <>
          <span class="truncate block max-w-[150px] mr-2 text-sm md:text-base">
            {currentLabel}
          </span>
          <div class="absolute right-[1.2rem] top-1/2 -translate-y-1/2 text-primary pointer-events-none">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="3"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="transition-transform duration-300"
              id={`arrow-${id}`}
            >
              <path d="m6 9 6 6 6-6" />
            </svg>
          </div>
        </>
      ) : (
        <slot name="trigger" />
      )
    }
  </button>

  <div
    id={`menu-${id}`}
    class={menuClass ||
      "absolute top-[calc(100%+8px)] right-0 left-0 min-w-[220px] max-h-[300px] overflow-y-auto p-2 hidden flex-col gap-1 z-[100] shadow-[0_10px_40px_rgba(0,0,0,0.5)] bg-[#1a1a1a] rounded-[1.5rem] border border-white/10 origin-top"}
  >
    {
      isSelect ? (
        <>
          <div
            class="dropdown-item px-4 py-3 rounded-xl text-sm font-bold text-text-muted hover:text-white hover:bg-white/5 transition-all cursor-pointer flex items-center justify-between group"
            data-value=""
          >
            {placeholder}
            {value === "" && (
              <div class="w-1.5 h-1.5 bg-primary rounded-full shadow-[0_0_8px_#f63049]" />
            )}
          </div>
          {normalizedOptions.map((opt) => (
            <div
              class="dropdown-item px-4 py-3 rounded-xl text-sm font-bold text-text-muted hover:text-white hover:bg-white/5 transition-all cursor-pointer flex items-center justify-between group"
              data-value={opt.value}
            >
              {opt.label}
              {value === opt.value && (
                <div class="w-1.5 h-1.5 bg-primary rounded-full shadow-[0_0_8px_#f63049]" />
              )}
            </div>
          ))}
        </>
      ) : (
        <slot />
      )
    }
  </div>
</div>

<script define:vars={{ id, submitOnChange, isSelect, closeOnClickInside }}>
  // Initialize function to allow re-running on navigation
  const initDropdown = () => {
    const container = document.getElementById(`dropdown-${id}`);
    const toggle = document.getElementById(`toggle-${id}`);
    const menu = document.getElementById(`menu-${id}`);

    // Select Elements
    const input = document.getElementById(`input-${id}`);
    const arrow = document.getElementById(`arrow-${id}`);
    const items = container?.querySelectorAll(".dropdown-item");

    if (container && toggle && menu) {
      // Use a flag to check if listeners attached (or remove old ones by recreating elements,
      // but simple removeEventListener is harder with anonymous functions.
      // Cloning node is a clean way to wipe listeners)

      const newToggle = toggle.cloneNode(true);
      toggle.parentNode.replaceChild(newToggle, toggle);
      const activeToggle = document.getElementById(`toggle-${id}`);

      // Toggle Logic
      activeToggle.addEventListener("click", (e) => {
        e.stopPropagation();
        const isHidden = menu.classList.contains("hidden");

        // Close all other dropdowns
        document.querySelectorAll('[id^="menu-"]').forEach((m) => {
          if (m.id !== `menu-${id}`) {
            m.classList.add("hidden");
            m.classList.remove("flex", "animate-reveal-drop");
          }
        });

        if (isHidden) {
          menu.classList.remove("hidden");
          menu.classList.add("flex", "animate-reveal-drop");
          if (arrow) arrow.classList.add("rotate-180");
        } else {
          menu.classList.add("hidden");
          menu.classList.remove("flex", "animate-reveal-drop");
          if (arrow) arrow.classList.remove("rotate-180");
        }
      });

      // Click Outside Logic
      const clickOutside = (e) => {
        if (!container.contains(e.target)) {
          menu.classList.add("hidden");
          menu.classList.remove("flex", "animate-reveal-drop");
          if (arrow) arrow.classList.remove("rotate-180");
        }
      };
      // Add globally (idempotent if already added? No, acts as stacking.
      // But since we navigate, old listeners might be gone if document reload.
      // For SPA, we should be careful. But Astro ViewTransitions usually handles scripts well if not inline?)
      // Let's rely on standard behavior.
      document.addEventListener("click", clickOutside);

      // Selection Logic (Select Mode)
      if (isSelect && items && input) {
        items.forEach((item) => {
          const newItem = item.cloneNode(true);
          item.parentNode.replaceChild(newItem, item);
        });
        const activeItems = container.querySelectorAll(".dropdown-item");

        activeItems.forEach((item) => {
          item.addEventListener("click", () => {
            const value = item.getAttribute("data-value");
            input.value = value || "";

            const label = item.textContent?.trim() || "";
            const span = activeToggle.querySelector("span");
            if (span) span.textContent = label;

            menu.classList.add("hidden");
            menu.classList.remove("flex", "animate-reveal-drop");
            if (arrow) arrow.classList.remove("rotate-180");

            if (submitOnChange) {
              input.closest("form")?.submit();
            }
          });
        });
      }
    }
  };

  initDropdown();
  document.addEventListener("astro:page-load", initDropdown);
</script>
