---
import "../styles/global.css";

interface Props {
  title: string;
  description?: string;
  image?: string;
  canonicalURL?: string;
  type?: "website" | "article";
}

const {
  title,
  description = "栞 Shiori - บันทึกความทรงจำและเรื่องราวที่น่าสนใจรอบตัว",
  image = "/image.png", // Default OG image
  canonicalURL = Astro.url.href,
  type = "website",
} = Astro.props;

const siteTitle = `${title} | Shiori 栞`;

import { getSession } from "auth-astro/server";
import { SignOut } from "auth-astro/components";
import { Toaster } from "react-hot-toast";
import { getOptimizedImageUrl } from "../lib/images";
import { Image } from "astro:assets";
import { ClientRouter } from "astro:transitions";
import Dropdown from "../components/ui/Dropdown.astro";

const session = await getSession(Astro.request);

// Calculate user avatar URL with fallback
const userName = session?.user?.name || "User";
const fallbackAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=f63049&color=fff`;
const userAvatar =
  session?.user?.image && session.user.image !== ""
    ? getOptimizedImageUrl(session.user.image, 64) // Tiny for header
    : fallbackAvatar;
---

<!doctype html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />

    <!-- Primary Meta Tags -->
    <title>{siteTitle}</title>
    <meta name="title" content={siteTitle} />
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={type} />
    <meta property="og:url" content={Astro.url.href} />
    <meta property="og:title" content={siteTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(image, Astro.url)} />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={Astro.url.href} />
    <meta property="twitter:title" content={siteTitle} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={new URL(image, Astro.url)} />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://res.cloudinary.com" />

    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&family=Plus+Jakarta+Sans:ital,wght@0,400;0,500;0,600;1,400&family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Cloudinary -->
    <script
      is:inline
      src="https://upload-widget.cloudinary.com/global/all.js"
      type="text/javascript"></script>

    <!-- Google Analytics -->
    <script
      is:inline
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-7HMDPM75DV"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-7HMDPM75DV");
    </script>
    <ClientRouter />
  </head>
  <body class="bg-bg font-main text-white leading-relaxed">
    <Toaster
      client:load
      toastOptions={{
        style: {
          background: "rgba(30, 30, 30, 0.8)",
          backdropFilter: "blur(10px)",
          border: "1px solid rgba(255, 255, 255, 0.1)",
          color: "#fff",
          fontFamily: "var(--font-main)",
          borderRadius: "12px",
        },
        success: {
          iconTheme: {
            primary: "#4ade80",
            secondary: "black",
          },
        },
        error: {
          iconTheme: {
            primary: "#F63049",
            secondary: "white",
          },
        },
      }}
    />
    <div
      class="relative md:sticky top-0 z-1000 pt-6 md:pt-8 pointer-events-none transition-all duration-500"
    >
      <div class="container">
        <nav
          class="glass-premium pointer-events-auto rounded-full px-6 md:px-10 border border-white/5 transition-all duration-300 shadow-2xl"
        >
          <div class="flex justify-between items-center h-14 md:h-16">
            <a
              href="/"
              class="group flex items-center font-extrabold text-2xl -tracking-[0.05em] text-white no-underline"
            >
              <div
                class="lantern-icon w-8 h-10 flex flex-col items-center mr-0 md:mr-5 relative transition-all duration-300 drop-shadow-[0_4px_10px_rgba(246,48,73,0.4)] group-hover:drop-shadow-[0_0_20px_rgba(246,48,73,0.8)]"
              >
                <div class="w-4 h-1 bg-[#1a1a1a] rounded-sm"></div>
                <div
                  class="flex-1 w-7 bg-linear-to-r from-primary via-[#cc233b] to-primary rounded-[10px] relative flex flex-col justify-evenly border border-black/20 overflow-hidden"
                >
                  <div
                    class="w-full h-px bg-black/40 shadow-[0_1px_0_rgba(255,255,255,0.1)]"
                  >
                  </div>
                  <div
                    class="w-full h-px bg-black/40 shadow-[0_1px_0_rgba(255,255,255,0.1)]"
                  >
                  </div>
                </div>
                <div class="w-4 h-1 bg-[#1a1a1a] rounded-sm"></div>
              </div>
              <span
                class="font-heading font-black text-base tracking-[0.5em] uppercase opacity-90 text-white transition-all duration-500 hidden md:inline ml-4 group-hover:tracking-[0.6em] group-hover:opacity-100 group-hover:text-primary"
                >Shiori</span
              >
            </a>
            <div class="flex items-center gap-8">
              <div class="hidden md:flex gap-10">
                <a
                  href="/"
                  class="text-text-muted font-bold text-sm uppercase tracking-widest no-underline hover:text-white hover:drop-shadow-[0_0_8px_rgba(255,255,255,0.3)] transition-all"
                  >หน้าแรก</a
                >
                <a
                  href="/blog"
                  class="text-text-muted font-bold text-sm uppercase tracking-widest no-underline hover:text-white hover:drop-shadow-[0_0_8px_rgba(255,255,255,0.3)] transition-all"
                  >รวมบันทึก</a
                >
              </div>

              <div
                class="border-l border-white/10 pl-6 ml-2 md:pl-6 md:ml-2 flex items-center max-md:border-l-0 max-md:pl-0"
              >
                {
                  session ? (
                    <Dropdown
                      triggerClass="bg-transparent border-none p-0 cursor-pointer flex items-center transition-transform duration-200 hover:scale-105"
                      menuClass="absolute top-[calc(100%+20px)] right-0 min-w-[220px] p-4 hidden flex-col gap-1.5 z-[1001] shadow-[0_10px_40px_rgba(0,0,0,0.5)] bg-[#1a1a1a] rounded-[1.5rem] border border-white/10 origin-top"
                    >
                      <Image
                        slot="trigger"
                        src={userAvatar}
                        alt={userName}
                        width={32}
                        height={32}
                        loading="eager"
                        class="w-8 h-8 rounded-full border-2 border-primary object-cover"
                      />

                      <div class="px-4 py-2 mb-1">
                        <p class="text-xs font-bold text-white opacity-40 uppercase tracking-widest mb-1">
                          Signed in as
                        </p>
                        <p class="text-sm font-bold text-white truncate max-w-full">
                          {session.user?.name}
                        </p>
                      </div>

                      <div class="h-px bg-white/5 mx-2 mb-1" />

                      {(session.user?.email === import.meta.env.ADMIN_EMAIL ||
                        (session.user as any).role === "admin") && (
                        <a
                          href="/admin"
                          class="flex items-center gap-3 px-4 py-2.5 rounded-xl text-sm text-white no-underline hover:bg-primary/20 hover:text-primary transition-all group/item"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="18"
                            height="18"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="opacity-50 group-hover/item:opacity-100"
                          >
                            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                            <circle cx="12" cy="12" r="3" />
                          </svg>
                          <span class="font-bold">Manage Posts</span>
                        </a>
                      )}

                      <a
                        href="/profile"
                        class="flex items-center gap-3 px-4 py-2.5 rounded-xl text-sm text-text-muted no-underline hover:bg-white/5 hover:text-white transition-all group/item"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="18"
                          height="18"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          class="opacity-50 group-hover/item:opacity-100"
                        >
                          <>
                            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
                            <circle cx="12" cy="7" r="4" />
                          </>
                        </svg>
                        <span>Profile Info</span>
                      </a>

                      <a
                        href="/profile?tab=activity"
                        class="flex items-center gap-3 px-4 py-2.5 rounded-xl text-sm text-text-muted no-underline hover:bg-white/5 hover:text-white transition-all group/item"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="18"
                          height="18"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          class="opacity-50 group-hover/item:opacity-100"
                        >
                          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                        </svg>
                        <span>My Activity</span>
                      </a>

                      <div class="h-px bg-white/5 mx-2 my-1" />

                      <SignOut class="btn-logout-dropdown bg-transparent border-none cursor-pointer flex items-center gap-3 px-4 py-2.5 rounded-xl text-sm text-text-muted w-full hover:bg-primary/10 hover:text-primary transition-all group/item">
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="18"
                          height="18"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          class="opacity-50 group-hover/item:opacity-100"
                        >
                          <>
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                            <polyline points="16 17 21 12 16 7" />
                            <line x1="21" y1="12" x2="9" y2="12" />
                          </>
                        </svg>
                        <span class="font-bold">Logout</span>
                      </SignOut>
                    </Dropdown>
                  ) : (
                    <a
                      href="/login"
                      class="flex items-center gap-2 bg-primary text-white py-2 px-5 rounded-full font-semibold text-sm border-none cursor-pointer transition-all duration-300 no-underline leading-normal hover:bg-secondary hover:-translate-y-0.5 hover:shadow-[0_5px_15px_rgba(246,48,73,0.4)]"
                    >
                      Login
                    </a>
                  )
                }
              </div>
            </div>
          </div>
        </nav>
      </div>
    </div>
    <main class="min-h-[80vh] pt-4 md:pt-8">
      <slot />
    </main>
    <footer
      class="py-16 px-4 text-center text-text-muted border-t border-white/5"
    >
      <div class="container">
        <div class="flex flex-wrap justify-center items-center gap-6 mb-6">
          <a
            href="/"
            class="text-text-muted text-[0.95rem] font-medium hover:text-white transition-colors no-underline"
            >หน้าหลัก</a
          >
          <span class="opacity-30 hidden sm:inline">•</span>
          <a
            href="/about"
            class="text-text-muted text-[0.95rem] font-medium hover:text-white transition-colors no-underline"
            >เกี่ยวกับผม</a
          >
          <span class="opacity-30 hidden sm:inline">•</span>
          <a
            href="/blog"
            class="text-text-muted text-[0.95rem] font-medium hover:text-white transition-colors no-underline"
            >รวมบันทึก</a
          >
          <span class="opacity-30 hidden sm:inline">•</span>
          <a
            href="/privacy"
            class="text-text-muted text-[0.95rem] font-medium hover:text-white transition-colors no-underline"
            >นโยบายความเป็นส่วนตัว</a
          >
          <span class="opacity-30 hidden sm:inline">•</span>
          <a
            href="/terms"
            class="text-text-muted text-[0.95rem] font-medium hover:text-white transition-colors no-underline"
            >ข้อตกลงการใช้งาน</a
          >
        </div>
        <p class="text-sm opacity-60">
          &copy; {new Date().getFullYear()} Shiori 栞. All rights reserved.
        </p>
      </div>
    </footer>
  </body>
</html>

<style>
  .lantern-icon {
    transform-origin: top center;
  }
  .group:hover .lantern-icon {
    animation: swing 1s ease-in-out infinite alternate;
  }
  @keyframes swing {
    from {
      transform: rotate(-5deg) scale(1.1);
    }
    to {
      transform: rotate(15deg) scale(1.1);
    }
  }

  .show {
    display: flex !important;
  }

  @keyframes reveal-drop {
    from {
      opacity: 0;
      transform: translateY(-20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  .animate-reveal-drop {
    animation: reveal-drop 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }
</style>
