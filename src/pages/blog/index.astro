---
import Layout from "../../layouts/Layout.astro";
import { db, Post, desc, sql } from "astro:db";
import BlogFeed from "../../components/BlogFeed";

// Handle dynamic routing/rendering in Astro SSR mode
export const prerender = false;

// 1. Initial Page Load Param
const limit = 9;
const offset = 0;

// 2. Fetch Unique Categories for Filter Dropdown
const categoriesResult = await db
  .selectDistinct({ category: Post.category })
  .from(Post)
  .all();
const allCategories = categoriesResult.map((c) => c.category);

// 3. Fetch Initial Posts (Page 1, No Filters)
// Note: We ignore URL queries for SSR here to keep cache simple or let client handle deep linking state manually if needed.
// Or, if we want SSR to respect deep linking, we can parse URL here. But let's keep it simple: SSR initial load, then Client takes over.
// Actually, it's better if SSR matches client initial state. But for "No Reload" request, Client-side primary logic is fine.
const posts = await db
  .select()
  .from(Post)
  .orderBy(desc(Post.createdAt))
  .limit(limit)
  .offset(offset);

// 4. Total count for Initial Pagination
const totalCountResult = await db.select({ count: sql`count(*)` }).from(Post);
const totalCount = Number(totalCountResult[0].count);
const totalPages = Math.ceil(totalCount / limit);

const initialPosts = posts.map((post) => ({
  ...post,
  image:
    post.imageUrl ||
    "https://placehold.co/600x400/1a1a1a/F63049?text=Shiori+Blog",
  createdAt: new Date(post.createdAt).toISOString(), // Serialize date for React
}));
---

<Layout
  title="รวมบันทึกทั้งหมด"
  description="อ่านบันทึก เรื่องราวเทคโนโลยี และแนวคิดต่างๆ ที่น่าสนใจจาก Shiori 栞"
  type="website"
>
  <div class="container pt-8 pb-24 md:pt-8 md:pb-24 overflow-x-hidden">
    <header class="mb-20 text-center reveal">
      <h1
        class="text-4xl md:text-6xl font-black mb-6 pt-6 gradient-text leading-tight text-balance"
      >
        บันทึกทั้งหมด
      </h1>
      <p
        class="text-lg md:text-xl text-text-muted max-w-[600px] mx-auto stagger-1 reveal leading-relaxed"
      >
        คลังความทรงจำที่รวบรวมเรื่องราวที่อาจจะสำคัญ และบันทึกมั่วๆ ของผม
      </p>
    </header>

    <div class="reveal stagger-2">
      <BlogFeed
        initialPosts={initialPosts}
        allCategories={allCategories}
        initialTotalPages={totalPages}
        client:load
      />
    </div>
  </div>
</Layout>
