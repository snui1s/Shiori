---
import { Image } from "astro:assets";
import Layout from "../../layouts/Layout.astro";
import { db, Post, eq, User } from "astro:db";
import { getSession } from "auth-astro/server";
import { getOptimizedImageUrl } from "../../lib/images";
import Comments from "../../components/Comments";
import RelatedPosts from "../../components/RelatedPosts.astro";
import { getOptimizedContentHtml } from "../../lib/images";

const session = await getSession(Astro.request);

let currentUser = null;
let isAdmin = false;
if (session?.user?.email) {
  const [user] = await db
    .select()
    .from(User)
    .where(eq(User.email, session.user.email));
  currentUser = user;
  isAdmin =
    session.user.email === import.meta.env.ADMIN_EMAIL ||
    user?.role === "admin";
}

export const prerender = false;

const { id } = Astro.params;

const [entry] = await db
  .select()
  .from(Post)
  .where(eq(Post.slug, id as string));

if (!entry) {
  return Astro.redirect("/404");
}

const entryImageUrl =
  entry.imageUrl ||
  "https://placehold.co/1200x600/1a1a1a/F63049?text=Image+Lost+in+Translation...";

const post = {
  title: entry.title,
  excerpt: entry.excerpt,
  content: getOptimizedContentHtml(entry.content || ""),
  date:
    new Date(entry.createdAt).toLocaleString("th-TH", {
      timeZone: "Asia/Bangkok",
      year: "numeric",
      month: "short",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit",
    }) + " น.",
  category: entry.category,
  image: entryImageUrl, // Keep original for social previews
  optimizedImage: getOptimizedImageUrl(entryImageUrl, 1200), // High res for hero
  author: entry.author,
};

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: post.title,
  description: post.excerpt,
  image: post.image,
  author: {
    "@type": "Person",
    name: post.author,
  },
  datePublished: entry.createdAt.toISOString(),
  url: Astro.url.href,
};

const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": Astro.site
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Blog",
      "item": `${Astro.site}blog`
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": post.title,
      "item": Astro.url.href
    }
  ]
};
---

<Layout
  title={post.title}
  description={post.excerpt || ""}
  image={post.image}
  type="article"
>
  <script is:inline>
    function handleDetailImageError(img) {
      img.onerror = null;
      img.src =
        "https://placehold.co/1200x600/1a1a1a/F63049?text=Image+Lost+in+Translation...";
    }
  </script>
  <script
    is:inline
    type="application/ld+json"
    set:html={JSON.stringify(jsonLd)}
  />
  <script
    is:inline
    type="application/ld+json"
    set:html={JSON.stringify(breadcrumbJsonLd)}
  />
  <article class="container py-12 md:py-24 max-w-[1100px] mx-auto px-6 md:px-12 lg:px-6">
    <header class="text-center mb-16 max-w-[950px] mx-auto reveal">
      <span
        class="text-primary uppercase font-bold text-[0.8rem] tracking-[0.3em] mb-4 block"
        >{post.category}</span
      >
      <h1
        class="text-3xl md:text-[3.25rem] mt-4 mb-8 leading-[1.2] font-black h-gradient text-balance py-4"
      >
        {post.title}
      </h1>
      <div
        class="flex justify-center items-center mt-8 text-text-muted/60 text-[0.9rem] font-medium stagger-1 reveal"
      >
        <div class="flex items-center gap-3">
          <span>{post.date}</span>
          <div class="w-1 h-1 bg-white/20 rounded-full"></div>
          <span class="text-white/80">By {post.author}</span>
        </div>
      </div>
    </header>

    <div
      class="w-full max-w-[1000px] h-[300px] md:h-[500px] mx-auto mb-16 overflow-hidden rounded-4xl glass-premium shadow-2xl reveal stagger-2 skeleton"
    >
      <Image
        src={post.optimizedImage}
        alt={post.title}
        width={1200}
        height={600}
        loading="eager"
        fetchpriority="high"
        class="w-full h-full object-cover grayscale-[0.2] hover:grayscale-0 transition-all duration-1000 scale-105 hover:scale-100"
      />
    </div>

    <div
      class="glass-premium p-8 md:p-20 rounded-[3rem] text-base md:text-[1.125rem] leading-relaxed md:leading-[1.9] text-slate-300 w-full mb-20 reveal stagger-3 border border-white/5 shadow-2xl"
    >
      <p
        class="text-lg md:text-[1.3rem] text-white font-bold mb-12 leading-[1.4] border-l-8 border-primary pl-8 md:pl-14 py-8 md:py-12 pr-8 md:pr-12 bg-white/3 rounded-r-4xl italic shadow-2xl relative overflow-hidden"
      >
        <span class="relative z-10">{post.excerpt}</span>
      </p>
      <div class="rich-text-content" set:html={post.content} />
    </div>

    <Comments
      client:load
      postId={entry.id}
      session={session}
      currentUser={currentUser}
      isAdmin={isAdmin}
    />

    <RelatedPosts 
      currentPostId={entry.id} 
      currentCategory={entry.category} 
    />

    <footer class="mt-24 pt-16 border-t border-white/5 flex justify-center">
      <a
        href="/"
        class="group inline-flex items-center gap-3 py-4 px-10 bg-white/3 border border-white/10 rounded-full text-white font-semibold transition-all duration-400 no-underline hover:bg-primary hover:border-primary hover:-translate-y-1 hover:shadow-[0_10px_25px_rgba(246,48,73,0.3)]"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="transition-transform duration-300 group-hover:-translate-x-1.5"
        >
          <line x1="19" y1="12" x2="5" y2="12"></line>
          <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
        กลับหน้าหลัก
      </a>
    </footer>
  </article>
</Layout>
