---
import Layout from "../layouts/Layout.astro";
import { getSession } from "auth-astro/server";
import { db, PostComment, Post, User, eq, desc } from "astro:db";

export const prerender = false;

const session = await getSession(Astro.request);

if (!session) {
  return Astro.redirect("/login?callbackUrl=/profile");
}

const userEmail = session.user?.email;
const currentUser = await db
  .select()
  .from(User)
  .where(eq(User.email, userEmail || ""))
  .then((res) => res[0]);

if (!currentUser) {
  return Astro.redirect("/login");
}

const userComments = await db
  .select({
    id: PostComment.id,
    content: PostComment.content,
    createdAt: PostComment.createdAt,
    postTitle: Post.title,
    postSlug: Post.slug,
  })
  .from(PostComment)
  .where(eq(PostComment.userId, currentUser.id))
  .innerJoin(Post, eq(PostComment.postId, Post.id))
  .orderBy(desc(PostComment.createdAt));

const tab = Astro.url.searchParams.get("tab") || "info";

const CLOUD_NAME = import.meta.env.PUBLIC_CLOUDINARY_CLOUD_NAME;
const UPLOAD_PRESET = import.meta.env.PUBLIC_CLOUDINARY_UPLOAD_PRESET;
---

<Layout title="โปรไฟล์">
  <div class="min-h-screen flex items-start justify-center p-4 pt-16 md:pt-28">
    <div class="w-full max-w-[500px] animate-slide-up">
      {/* ── Avatar + Name Header ── */}
      <div class="flex flex-col items-center mb-10">
        <div class="relative mb-5 group">
          <img
            id="avatar-preview"
            src={currentUser.image ||
              `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.name || "U")}&background=f63049&color=fff`}
            alt={currentUser.name}
            class="w-24 h-24 rounded-full object-cover border-2 border-white/10 shadow-lg transition-transform duration-300 group-hover:scale-105"
          />
          {
            tab === "info" && (
              <button
                type="button"
                id="avatar-overlay-btn"
                class="absolute inset-0 rounded-full flex items-center justify-center bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer border-none"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="22"
                  height="22"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="text-white"
                >
                  <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                  <circle cx="12" cy="13" r="4" />
                </svg>
              </button>
            )
          }
        </div>
        <h1 class="text-2xl font-extrabold text-white mb-1">
          {currentUser.name}
        </h1>
        <p class="text-sm text-text-muted">{currentUser.email}</p>
      </div>

      {/* ── Tab Navigation ── */}
      <div class="flex gap-2 mb-6">
        <a
          href="/profile"
          class={`flex-1 text-center py-3 rounded-xl text-sm font-semibold no-underline transition-all ${
            tab === "info"
              ? "bg-primary text-white shadow-[0_4px_12px_rgba(246,48,73,0.3)]"
              : "bg-white/5 text-text-muted hover:bg-white/10 hover:text-white"
          }`}
        >
          ตั้งค่าโปรไฟล์
        </a>
        <a
          href="/profile?tab=activity"
          class={`flex-1 text-center py-3 rounded-xl text-sm font-semibold no-underline transition-all ${
            tab === "activity"
              ? "bg-primary text-white shadow-[0_4px_12px_rgba(246,48,73,0.3)]"
              : "bg-white/5 text-text-muted hover:bg-white/10 hover:text-white"
          }`}
        >
          กิจกรรมของฉัน
        </a>
      </div>

      {/* ── Content Card ── */}
      <div
        class="glass p-8 md:p-10 rounded-[24px] shadow-[0_20px_60px_rgba(0,0,0,0.3)] border border-white/5"
      >
        {
          tab === "info" ? (
            <form id="profile-form" class="flex flex-col gap-6">
              <div class="flex flex-col gap-2">
                <label
                  for="name-input"
                  class="text-[0.9rem] font-medium text-white ml-1"
                >
                  ชื่อที่แสดง
                </label>
                <input
                  type="text"
                  id="name-input"
                  name="name"
                  value={currentUser.name}
                  placeholder="Username ของคุณ"
                  required
                  class="py-3.5 px-5 bg-white/5 border border-white/10 rounded-xl text-base text-white outline-none transition-all duration-300 focus:bg-white/10 focus:border-primary focus:ring-4 focus:ring-primary/10 placeholder:text-white/30"
                />
              </div>

              <div class="flex flex-col gap-2">
                <label class="text-[0.9rem] font-medium text-white ml-1">
                  รูปโปรไฟล์
                </label>
                <button
                  type="button"
                  id="upload-trigger"
                  class="py-3.5 px-5 bg-white/5 border border-dashed border-white/10 rounded-xl text-base text-text-muted outline-none transition-all duration-300 hover:bg-white/10 hover:border-primary hover:text-white cursor-pointer flex items-center justify-center gap-3"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                    <polyline points="17 8 12 3 7 8" />
                    <line x1="12" y1="3" x2="12" y2="15" />
                  </svg>
                  <span id="upload-label">อัปโหลดรูปภาพใหม่</span>
                </button>
                <p class="text-[0.8rem] text-text-muted/50 ml-1">
                  Powered by Cloudinary ☁️
                </p>
              </div>

              <div class="flex flex-col gap-2 opacity-50">
                <label class="text-[0.9rem] font-medium text-white ml-1">
                  อีเมล
                </label>
                <div class="py-3.5 px-5 bg-white/5 border border-white/10 rounded-xl text-base text-text-muted select-none flex items-center gap-3">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="opacity-40"
                  >
                    <rect width="20" height="16" x="2" y="4" rx="2" />
                    <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7" />
                  </svg>
                  {currentUser.email}
                </div>
              </div>

              <button
                type="submit"
                id="save-btn"
                class="bg-primary text-white py-4 rounded-xl text-[1.1rem] font-semibold transition-all duration-300 mt-2 shadow-[0_4px_12px_rgba(246,48,73,0.3)] hover:bg-secondary hover:-translate-y-0.5 hover:shadow-[0_8px_20px_rgba(246,48,73,0.4)] cursor-pointer disabled:opacity-70 disabled:cursor-not-allowed"
              >
                บันทึกการเปลี่ยนแปลง
              </button>
            </form>
          ) : (
            <div>
              {userComments.length === 0 ? (
                <div class="text-center py-12">
                  <p class="text-text-muted mb-6">ยังไม่มีกิจกรรมในขณะนี้</p>
                  <a
                    href="/blog"
                    class="inline-block py-3 px-8 bg-primary text-white rounded-xl font-semibold no-underline shadow-[0_4px_12px_rgba(246,48,73,0.3)] hover:bg-secondary hover:-translate-y-0.5 transition-all"
                  >
                    ไปอ่านบล็อก
                  </a>
                </div>
              ) : (
                <div class="flex flex-col gap-5">
                  {userComments.map((comment) => (
                    <div class="p-5 bg-white/[0.03] rounded-2xl border border-white/5 hover:border-white/10 transition-all">
                      <div class="flex items-center justify-between mb-3">
                        <span class="text-xs font-bold text-primary">
                          {new Date(comment.createdAt).toLocaleDateString(
                            "th-TH",
                            { day: "numeric", month: "short", year: "numeric" },
                          )}
                        </span>
                        <a
                          href={`/blog/${comment.postSlug}`}
                          class="text-xs font-medium text-text-muted no-underline hover:text-primary transition-colors"
                        >
                          ดูโพสต์ →
                        </a>
                      </div>
                      <p class="text-white text-[0.95rem] leading-relaxed mb-3">
                        {comment.content}
                      </p>
                      <p class="text-xs text-text-muted/50">
                        ในโพสต์: {comment.postTitle}
                      </p>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )
        }
      </div>
    </div>
  </div>
</Layout>

<script define:vars={{ CLOUD_NAME, UPLOAD_PRESET }}>
  document.addEventListener("astro:page-load", () => {
    const profileForm = document.getElementById("profile-form");
    const saveBtn = document.getElementById("save-btn");
    const nameInput = document.getElementById("name-input");
    const uploadTrigger = document.getElementById("upload-trigger");
    const avatarOverlayBtn = document.getElementById("avatar-overlay-btn");
    const avatarPreview = document.getElementById("avatar-preview");
    const uploadLabel = document.getElementById("upload-label");

    let uploadedImageUrl = "";

    // === Custom Toast Function (Safe & Beautiful) ===
    const showToast = (message, type = "success") => {
      // Remove existing toasts
      const existing = document.querySelectorAll(".custom-toast");
      existing.forEach((el) => el.remove());

      const toast = document.createElement("div");
      toast.className = `custom-toast fixed top-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full shadow-[0_10px_30px_rgba(0,0,0,0.3)] z-[9999] text-white font-medium text-sm flex items-center gap-2 transition-all duration-500 ease-out transform -translate-y-[150%] opacity-0 backdrop-blur-md border border-white/10 ${
        type === "success" ? "bg-emerald-500/90" : "bg-rose-500/90"
      }`;

      const icon =
        type === "success"
          ? `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`
          : `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`;

      toast.innerHTML = `${icon}<span>${message}</span>`;
      document.body.appendChild(toast);

      // Animate In
      requestAnimationFrame(() => {
        toast.style.transform = "translate(-50%, 0)";
        toast.style.opacity = "1";
      });

      // Auto Dismiss
      setTimeout(() => {
        toast.style.transform = "translate(-50%, -150%)";
        toast.style.opacity = "0";
        setTimeout(() => toast.remove(), 500);
      }, 3000);
    };

    // Cloudinary Widget Function
    const openWidget = () => {
      // @ts-ignore
      if (typeof window.cloudinary === "undefined") {
        showToast("กำลังโหลดระบบอัปโหลด... ลองใหม่ใน 3 วิ", "error");
        return;
      }

      // @ts-ignore
      const widget = window.cloudinary.createUploadWidget(
        {
          cloudName: CLOUD_NAME,
          uploadPreset: UPLOAD_PRESET,
          sources: ["local", "camera"],
          multiple: false,
          cropping: true,
          croppingAspectRatio: 1,
          showSkipCropButton: false,
          folder: "shiori_avatars",
          clientAllowedFormats: ["png", "jpeg", "webp"],
          maxFileSize: 5000000,
          styles: {
            palette: {
              window: "#0f172a",
              windowBorder: "#f63049",
              tabIcon: "#f63049",
              menuIcons: "#ffffff",
              textDark: "#0f172a",
              textLight: "#ffffff",
              link: "#f63049",
              action: "#f63049",
              inProgress: "#f63049",
              complete: "#20b2aa",
              sourceBg: "#1e293b",
            },
          },
        },
        (error, result) => {
          if (!error && result && result.event === "success") {
            uploadedImageUrl = result.info.secure_url;
            if (avatarPreview) avatarPreview.src = uploadedImageUrl;
            if (uploadLabel) uploadLabel.textContent = "เปลี่ยนรูปภาพใหม่";
            showToast("อัปโหลดรูปภาพสำเร็จ!", "success");
          }
        },
      );
      widget.open();
    };

    if (uploadTrigger) uploadTrigger.addEventListener("click", openWidget);
    if (avatarOverlayBtn)
      avatarOverlayBtn.addEventListener("click", openWidget);

    // Profile form submit
    if (profileForm && saveBtn) {
      profileForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const name = nameInput.value;
        const originalText = saveBtn.textContent;
        saveBtn.textContent = "กำลังบันทึก...";
        saveBtn.disabled = true;

        try {
          const res = await fetch("/api/user/update", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              name,
              image: uploadedImageUrl || undefined,
            }),
          });

          const data = await res.json();

          if (res.ok) {
            showToast("บันทึกข้อมูลเรียบร้อยแล้ว!", "success");
            // Reload page after slightly longer delay to show checkmark
            setTimeout(() => window.location.reload(), 1500);
          } else {
            showToast(data.error || "การบันทึกล้มเหลว", "error");
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
          }
        } catch (err) {
          showToast("เกิดข้อผิดพลาดในการเชื่อมต่อ", "error");
          saveBtn.textContent = originalText;
          saveBtn.disabled = false;
        }
      });
    }
  });
</script>

<style>
  @keyframes slide-up {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .animate-slide-up {
    animation: slide-up 0.6s ease-out;
  }
</style>
