---
import Layout from "../../layouts/Layout.astro";
import { db, Post, desc } from "astro:db";
import { getSession } from "auth-astro/server";
import { SignIn } from "auth-astro/components";

export const prerender = false;

// Auth Check
const session = await getSession(Astro.request);

// Logic: Check if logged in AND has admin role (or matches your specific email)
const isAuthorized =
  session?.user &&
  (session.user.email === import.meta.env.ADMIN_EMAIL ||
    session.user.role === "admin");

if (!isAuthorized && session) {
  return Astro.redirect("/?error=unauthorized");
}

const posts = await db.select().from(Post).orderBy(desc(Post.createdAt));
---

<Layout title="Admin Dashboard">
  <div class="container py-16 md:py-24 min-h-[80vh] flex justify-center">
    {
      !isAuthorized ? (
        <div class="max-w-[420px] w-full p-12 text-center glass rounded-4xl self-center animate-fade-in">
          <h1 class="text-[2.5rem] font-bold mb-4 h-gradient">Admin Access</h1>
          <p class="text-text-muted mb-8 text-base leading-relaxed">
            เฉพาะผู้ดูแลระบบเท่านั้นที่สามารถเข้าถึงส่วนนี้ได้
          </p>
          {!session ? (
            <SignIn
              provider="google"
              class="w-full py-4 bg-primary text-white rounded-xl font-bold flex justify-center items-center gap-2 shadow-[0_4px_12px_rgba(246,48,73,0.3)] hover:bg-secondary hover:-translate-y-0.5 hover:shadow-[0_8px_20px_rgba(246,48,73,0.4)] transition-all cursor-pointer"
            >
              Login with Google
            </SignIn>
          ) : (
            <div class="text-[#ff4d4d] font-semibold bg-[#ff4d4d]/10 p-4 rounded-xl">
              ขออภัย บัญชีของคุณไม่มีสิทธิ์เข้าใช้งาน
            </div>
          )}
        </div>
      ) : (
        <div class="w-full animate-fade-in">
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-12">
            <div>
              <h1 class="text-[2.5rem] md:text-[3rem] font-bold h-gradient leading-tight">
                Dashboard 栞
              </h1>
              <p class="text-text-muted mt-2 text-lg">
                จัดการความทรงจำทั้งหมดของคุณ
              </p>
            </div>
            <div class="flex items-center gap-4 w-full md:w-auto">
              <a
                href="/admin/new"
                class="flex-1 md:flex-none justify-center bg-primary text-white px-6 h-[46px] rounded-full font-bold flex items-center transition-all duration-300 shadow-[0_5px_15px_rgba(246,48,73,0.3)] hover:-translate-y-0.5 hover:shadow-[0_8px_25px_rgba(246,48,73,0.5)] no-underline"
              >
                + เขียนใหม่
              </a>
              <a
                href="/"
                class="flex-1 md:flex-none justify-center border border-white/10 text-text-muted px-6 h-[46px] rounded-full flex items-center transition-all duration-300 hover:border-white hover:text-white no-underline"
              >
                กลับหน้าหลัก
              </a>
            </div>
          </div>

          <div class="glass overflow-hidden rounded-3xl border border-white/5">
            {posts.length === 0 ? (
              <div class="py-24 text-center text-text-muted">
                <h3 class="text-xl font-bold text-white mb-2">
                  ยังไม่มีบันทึกใดๆ
                </h3>
                <p>มาเริ่มเขียนเรื่องแรกกันเถอะ!</p>
              </div>
            ) : (
              <div class="overflow-x-auto">
                <table class="w-full border-collapse text-left">
                  <thead>
                    <tr class="bg-white/2">
                      <th class="p-6 text-text-muted font-semibold text-[0.85rem] uppercase tracking-wider">
                        วันที่
                      </th>
                      <th class="p-6 text-text-muted font-semibold text-[0.85rem] uppercase tracking-wider">
                        หัวข้อ
                      </th>
                      <th class="p-6 text-text-muted font-semibold text-[0.85rem] uppercase tracking-wider">
                        หมวดหมู่
                      </th>
                      <th class="p-6 text-text-muted font-semibold text-[0.85rem] uppercase tracking-wider text-right">
                        จัดการ
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    {posts.map((post) => (
                      <tr
                        id={`post-${post.slug}`}
                        class="border-t border-white/5 transition-colors hover:bg-white/1"
                      >
                        <td class="p-6 text-text-muted whitespace-nowrap align-top">
                          {new Date(post.createdAt).toLocaleDateString(
                            "th-TH",
                            {
                              timeZone: "Asia/Bangkok",
                              day: "numeric",
                              month: "short",
                            },
                          )}
                        </td>
                        <td class="p-6 align-top">
                          <div class="font-bold text-lg text-white mb-1 leading-tight">
                            {post.title}
                          </div>
                          <div class="text-[0.8rem] text-text-muted font-mono bg-white/5 px-2 py-0.5 rounded inline-block">
                            /{post.slug}
                          </div>
                        </td>
                        <td class="p-6 align-top">
                          <span class="bg-primary/10 text-primary px-3 py-1 rounded-full text-[0.8rem] font-bold whitespace-nowrap">
                            {post.category}
                          </span>
                        </td>
                        <td class="p-6 align-top">
                          <div class="flex justify-end gap-3">
                            <a
                              href={`/admin/edit/${post.slug}`}
                              class="px-4 py-2 bg-white/5 text-white rounded-lg text-sm font-semibold transition-all hover:bg-white hover:text-black no-underline"
                            >
                              แก้
                            </a>
                            <button
                              class="px-4 py-2 bg-primary/10 text-primary rounded-lg text-sm font-semibold transition-all hover:bg-primary hover:text-white cursor-pointer btn-delete"
                              data-slug={post.slug}
                            >
                              ลบ
                            </button>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </div>
      )
    }
  </div>
</Layout>

<script>
  // Handle Delete
  const deleteButtons = document.querySelectorAll(".btn-delete");
  deleteButtons.forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      const target = e.target as HTMLButtonElement;
      const slug = target.dataset.slug;
      if (
        confirm(
          `คุณต้องการลบโพสต์ "${slug}" ใช่หรือไม่? ไม่สามารถเรียกคืนได้นะ!`,
        )
      ) {
        const originalText = target.innerText;
        target.innerText = "...";
        target.disabled = true;

        try {
          const res = await fetch(`/api/posts/${slug}`, { method: "DELETE" });
          if (res.ok) {
            const row = document.getElementById(`post-${slug}`);
            if (row) {
              row.style.opacity = "0";
              row.style.transform = "translateX(20px)";
              row.style.transition = "all 0.3s ease-out";
              setTimeout(() => row.remove(), 300);
            }
          } else {
            alert("เกิดข้อผิดพลาดในการลบ");
            target.innerText = originalText;
            target.disabled = false;
          }
        } catch (err) {
          alert("เกิดข้อผิดพลาดในการเชื่อมต่อ");
          target.innerText = "ลบ";
          target.disabled = false;
        }
      }
    });
  });
</script>

<style>
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .animate-fade-in {
    animation: fade-in 0.5s ease-out;
  }
  .h-gradient {
    background: linear-gradient(to right, #fff, #a0aec0);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }
</style>
