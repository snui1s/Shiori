---
import Layout from "../layouts/Layout.astro";
import { SignIn } from "auth-astro/components";
import { getSession } from "auth-astro/server";

const session = await getSession(Astro.request);
if (session) {
  return Astro.redirect("/");
}
---

<Layout title="Login">
  <div
    class="min-h-screen flex items-center justify-center bg-bg p-4 relative overflow-hidden"
  >
    <div
      class="login-card glass p-8 md:p-12 rounded-[24px] shadow-[0_20px_60px_rgba(0,0,0,0.3)] w-full max-w-[520px] z-[2] border border-white/5 animate-slide-up"
    >
      <h1
        class="text-[2rem] font-extrabold text-white mb-2 text-center -tracking-[0.5px]"
      >
        ยินดีต้อนรับกลับมา
      </h1>
      <p class="text-text-muted text-center mb-10 text-base leading-relaxed">
        กรุณากรอกข้อมูลเพื่อเข้าสู่ระบบ
      </p>

      <form class="login-form flex flex-col gap-6">
        <div class="flex flex-col gap-2">
          <label for="email" class="text-[0.9rem] font-medium text-white ml-1"
            >อีเมล</label
          >
          <input
            type="email"
            id="email"
            name="email"
            placeholder="กรอกอีเมลของคุณ"
            required
            class="py-3.5 px-5 bg-white/5 border border-white/10 rounded-xl text-base text-white outline-none transition-all duration-300 focus:bg-white/10 focus:border-primary focus:ring-4 focus:ring-primary/10 placeholder:text-white/30"
          />
        </div>

        <div class="flex flex-col gap-2">
          <label
            for="password"
            class="text-[0.9rem] font-medium text-white ml-1">รหัสผ่าน</label
          >
          <input
            type="password"
            id="password"
            name="password"
            placeholder="กรอกรหัสผ่าน"
            required
            class="py-3.5 px-5 bg-white/5 border border-white/10 rounded-xl text-base text-white outline-none transition-all duration-300 focus:bg-white/10 focus:border-primary focus:ring-4 focus:ring-primary/10 placeholder:text-white/30"
          />
        </div>

        <button
          type="submit"
          class="bg-primary text-white py-4 rounded-xl text-[1.1rem] font-semibold transition-all duration-300 mt-2 shadow-[0_4px_12px_rgba(246,48,73,0.3)] hover:bg-secondary hover:-translate-y-0.5 hover:shadow-[0_8px_20px_rgba(246,48,73,0.4)] cursor-pointer"
          >เข้าสู่ระบบ</button
        >
      </form>

      <div
        class="flex items-center gap-3 my-8 text-text-muted text-[0.9rem] font-medium before:content-[''] before:flex-1 before:h-px before:bg-white/10 after:content-[''] after:flex-1 after:h-px after:bg-white/10"
      >
        <span class="px-3">หรือดำเนินการต่อด้วย</span>
      </div>

      <SignIn
        provider="google"
        class="flex items-center justify-center gap-3 w-full py-3.5 bg-white rounded-xl text-base font-semibold text-[#1a1a1a] transition-all duration-200 hover:bg-[#f0f0f0] hover:-translate-y-0.5 hover:shadow-[0_4px_12px_rgba(0,0,0,0.1)] cursor-pointer"
        options={{ callbackUrl: "/" }}
      >
        <svg
          class="w-6 h-6"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
            fill="#4285F4"></path>
          <path
            d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
            fill="#34A853"></path>
          <path
            d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
            fill="#FBBC05"></path>
          <path
            d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
            fill="#EA4335"></path>
        </svg>
        <span>Google</span>
      </SignIn>

      <p class="text-center mt-8 text-[0.95rem] text-text-muted">
        ยังไม่มีบัญชี? <a
          href="/signup"
          class="text-primary font-bold no-underline hover:text-secondary hover:underline transition-colors"
          >ลงทะเบียน</a
        >
      </p>
    </div>
  </div>

  <style>
    @keyframes slide-up {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .animate-slide-up {
      animation: slide-up 0.6s ease-out;
    }
  </style>

  <script>
    import { signIn } from "auth-astro/client";
    import toast from "react-hot-toast";

    const form = document.querySelector(".login-form") as HTMLFormElement;

    // Check for error in URL (e.g. from OAuth redirect failure)
    const urlParams = new URL(window.location.href).searchParams;
    const error = urlParams.get("error");
    if (error) {
      if (error === "CredentialsSignin") {
        toast.error("อีเมลหรือรหัสผ่านไม่ถูกต้อง", {
          position: "top-center",
        });
      } else {
        toast.error("เกิดข้อผิดพลาดในการเข้าสู่ระบบ", {
          position: "top-center",
        });
      }
      // Clean URL
      window.history.replaceState({}, document.title, window.location.pathname);
    }

    form?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const email = formData.get("email");
      const password = formData.get("password");
      const submitBtn = form.querySelector(
        'button[type="submit"]',
      ) as HTMLButtonElement;

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = "กำลังเข้าสู่ระบบ...";

        const res = await signIn("credentials", {
          email,
          password,
          redirect: false,
        } as any);

        if (!res) {
          toast.error("ไม่ได้รับตอบสนองจากเซิร์ฟเวอร์", {
            position: "top-center",
          });
          submitBtn.disabled = false;
          submitBtn.textContent = "เข้าสู่ระบบ";
          return;
        }

        if (res.ok) {
          toast.success("เข้าสู่ระบบสำเร็จ!", {
            position: "top-center",
            duration: 2000,
          });

          setTimeout(() => {
            window.location.assign("/");
          }, 500);
          return;
        }

        let data;
        try {
          data = await res.json();
        } catch (e) {
          data = {};
        }

        if (data?.url && data.url.includes("error=")) {
          toast.error("อีเมลหรือรหัสผ่านไม่ถูกต้อง", {
            position: "top-center",
          });
        } else {
          toast.error("เกิดข้อผิดพลาดในการเข้าสู่ระบบ", {
            position: "top-center",
          });
        }

        submitBtn.disabled = false;
        submitBtn.textContent = "เข้าสู่ระบบ";
      } catch (error) {
        toast.error("เกิดข้อผิดพลาดในการเชื่อมต่อ", { position: "top-center" });
        submitBtn.disabled = false;
        submitBtn.textContent = "เข้าสู่ระบบ";
      }
    });
  </script>
</Layout>
